#!/usr/bin/env python
#-*- coding: utf-8 -*-

"""使用urllib2请求代理服务器
请求http和https网页均适用
"""

import tushare
import threading
import time
from urllib.request import urlopen, Request
import base64
import zlib

#要访问的目标网页
page_url = "http://hq.sinajs.cn/rn=3860948606925&list=sh603999,sh603996,sh603988,sh603987,sh603978,sh603977,sh603976,sh603970,sh603969,sh603966,sh603963,sh603960,sh603959,sh603958,sh603955,sh603937,sh603936,sh603933,sh603929,sh603928,sh603922,sh603920,sh603917,sh603916,sh603912,sh603908,sh603906,sh603903,sh603897,sh603890,sh603888,sh603887,sh603886,sh603882,sh603881,sh603876,sh603861,sh603860,sh603859,sh603856,sh603848,sh603829,sh603826,sh603822,sh603819,sh603817,sh603813,sh603811,sh603809,sh603803,sh603800,sh603798,sh603797,sh603779,sh603778,sh603777,sh603776,sh603738,sh603733,sh603727,sh603725,sh603722,sh603721,sh603717,sh603716,sh603712,sh603711,sh603709,sh603707,sh603703,sh603701,sh603689,sh603688,sh603685,sh603683,sh603680,sh603677,sh603676,sh603668,sh603661,sh603656,sh603655,sh603648,sh603638,sh603637,sh603633,sh603630,sh603628,sh603626,sh603619,sh603618,sh603615,sh603612,sh603608,sh603607,sh603605,sh603603,sh603596,sh603577,sh603559,sh603557,sh603533,sh603528,sh603527,sh603518,sh603516,sh603507,sh603506,sh603500,sh603499,sh603477,sh603466,sh603429,sh603421,sh603398,sh603396,sh603393,sh603388,sh603386,sh603378,sh603367,sh603366,sh603365,sh603363,sh603359,sh603356,sh603348,sh603339,sh603336,sh603330,sh603329,sh603323,sh603322,sh603321,sh603319,sh603309,sh603305,sh603299,sh603289,sh603283,sh603278,sh603277,sh603266,sh603258,sh603238,sh603232,sh603225,sh603218,sh603200,sh603189,sh603186,sh603183,sh603181,sh603179,sh603177,sh603168,sh603166,sh603165,sh603161,sh603157,sh603139,sh603138,sh603136,sh603133,sh603131,sh603129,sh603128,sh603126,sh603118,sh603110,sh603106,sh603103,sh603101,sh603100,sh603099,sh603098,sh603089,sh603088,sh603083,sh603080,sh603079,sh603078,sh603076,sh603069,sh603067,sh603063,sh603060,sh603059,sh603058,sh603056,sh603055,sh603050,sh603042,sh603040,sh603036,sh603035,sh603033,sh603029,sh603028,sh603027,sh603016,sh603013,sh603011,sh603010,sh603009,sh603007,sh603006,sh603005,sh601965,sh601949,sh601908,sh601882,sh601858,sh601838,sh601828,sh601619,sh601611,sh601595,sh601519,sh601518,sh601500,sh601388,sh601375,sh601366,sh601326,sh601228,sh601222,sh601212,sh601199,sh601177,sh601116,sh601108,sh601086,sh601038,sh601019,sh601015,sh601011,sh601002,sh600997,sh600992,sh600988,sh600985,sh600983,sh600981,sh600980,sh600973,sh600962,sh600960,sh600939,sh600933,sh600929,sh600908,sh600903,sh600901,sh600898,sh600890,sh600889,sh600888,sh600876,sh600868,sh600866,sh600865,sh600862,sh600860,sh600857,sh600855,sh600853,sh600848,sh600847,sh600846,sh600841,sh600838,sh600833,sh600830,sh600828,sh600825,sh600822,sh600821,sh600818,sh600815,sh600814,sh600812,sh600810,sh600802,sh600798,sh600794,sh600793,sh600792,sh600789,sh600783,sh600781,sh600776,sh600774,sh600773,sh600770,sh600769,sh600756,sh600743,sh600740,sh600735,sh600730,sh600727,sh600726,sh600722,sh600721,sh600716,sh600715,sh600710,sh600708,sh600698,sh600693,sh600692,sh600689,sh600684,sh600677,sh600676,sh600675,sh600667,sh600662,sh600657,sh600653,sh600652,sh600650,sh600647,sh600644,sh600636,sh600630,sh600626,sh600624,sh600620,sh600619,sh600618,sh600617,sh600616,sh600614,sh600609,sh600602,sh600601,sh600595,sh600594,sh600592,sh600590,sh600581,sh600580,sh600579,sh600577,sh600571,sh600569,sh600560,sh600558,sh600555,sh600552,sh600550,sh600546,sh600540,sh600537,sh600536,sh600532,sh600531,sh600530,sh600527,sh600526,sh600523,sh600520,sh600517,sh600513,sh600496,sh600495,sh600476,sh600469,sh600468,sh600463,sh600462,sh600459,sh600456,sh600455,sh600444,sh600433,sh600422,sh600419,sh600416,sh600405,sh600400,sh600391,sh600390,sh600389,sh600387,sh600386,sh600385,sh600381,sh600378,sh600371,sh600370,sh600367,sh600366,sh600363,sh600361,sh600360,sh600359,sh600358,sh600354,sh600353,sh600351,sh600345,sh600343,sh600339,sh600333,sh600330,sh600313,sh600311,sh600306,sh600303,sh600300,sh600295,sh600288,sh600284,sh600283,sh600281,sh600278,sh600272,sh600268,sh600261,sh600255,sh600251,sh600250,sh600249,sh600248,sh600246,sh600239,sh600237,sh600231,sh600227,sh600222,sh600215,sh600213,sh600211"

#代理服务器
proxy = "47.101.33.23:16818"

#用户名和密码(私密代理/独享代理)
username = b"842958037"
password = b"7mqzliim"

def fun_timer():
    try:
       for i in range(3): 
           req = Request(page_url)
           req.add_header("User-Agent","Mozilla/5.0 (Windows; U; MSIE 9.0; WIndows NT 9.0; en-US))")
           req.add_header("Accept-Encoding", "Gzip") #使用gzip压缩传输数据让访问更快
        #    auth = base64.b64encode('842958037:7mqzliim'.encode('utf-8'))
           req.add_header("Proxy-Authorization", "Basic ODQyOTU4MDM3OjdtcXpsaWlt")
        #    req.set_proxy(proxy, "http")
           r = urlopen(req)

           content_encoding = r.headers["Content-Encoding"]
           if content_encoding and "gzip" in content_encoding:
              print(zlib.decompress(r.read(), 16+zlib.MAX_WBITS)) #获取页面内容
           else:
               print(r.read())  #获取页面内容
    except Exception as e:
           print(e)
           pass
    global timer
    timer = threading.Timer(3, fun_timer)
    timer.start()

timer = threading.Timer(3, fun_timer)
timer.start()        